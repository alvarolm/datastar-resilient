var H=r=>{throw TypeError(r)};var M=(r,t,e)=>t.has(r)||H("Cannot "+e);var i=(r,t,e)=>(M(r,t,"read from private field"),e?e.call(r):t.get(r)),m=(r,t,e)=>t.has(r)?H("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),a=(r,t,e,n)=>(M(r,t,"write to private field"),n?n.call(r,e):t.set(r,e),e),p=(r,t,e)=>(M(r,t,"access private method"),e);var L=(r,t,e,n)=>({set _(s){a(r,t,s,e)},get _(){return i(r,t,n)}});var u=Symbol("unsafe"),T=new WeakMap,_=new Map,k="connect",Y="connected",V="disconnected",b=class{constructor(t=!1){this.enabled=t}info(...t){this.enabled&&console.info(...t)}warn(...t){this.enabled&&console.warn(...t)}error(...t){console.error(...t)}},$=class{constructor(t){this.raw=t||"",this._parsed=this._parse()}_parse(){let t=this.raw.split(";").map(s=>s.trim()),e=t[0].toLowerCase(),n={};for(let s=1;s<t.length;s++){let[o,f]=t[s].split("=").map(h=>h.trim());o&&f&&(n[o.toLowerCase()]=f.replace(/^["']|["']$/g,""))}return{mediaType:e,params:n}}get type(){return this._parsed.mediaType.split("/")[0]}get subtype(){return this._parsed.mediaType.split("/")[1]}get params(){return this._parsed.params}get isSSE(){return this._parsed.mediaType==="text/event-stream"}get isJSON(){return this._parsed.mediaType==="application/json"||this._parsed.mediaType.endsWith("+json")}get isHTML(){return this._parsed.mediaType==="text/html"}get isXML(){return this._parsed.mediaType==="application/xml"||this._parsed.mediaType==="text/xml"||this._parsed.mediaType.endsWith("+xml")}get isText(){return this.type==="text"}get isMultipart(){return this.type==="multipart"}get isFormData(){return this._parsed.mediaType==="multipart/form-data"}get isFormURLEncoded(){return this._parsed.mediaType==="application/x-www-form-urlencoded"}get isBinary(){return!this.isText&&!this.isJSON&&!this.isXML&&!this.isHTML}get charset(){return this.params.charset||"utf-8"}is(t){return this._parsed.mediaType===t.toLowerCase()}matches(t){return t instanceof RegExp?t.test(this._parsed.mediaType):new RegExp("^"+t.replace("*",".*")+"$").test(this._parsed.mediaType)}toString(){return this.raw}};var J="datastar-fetch";function j(r,t){let e=r.body.pipeThrough(t);return new Response(e,{status:r.status,statusText:r.statusText,headers:new Headers(r.headers)})}var U="X-Fetch-Id";function O(r){let t={type:"datastar-patch-signals",argsRaw:{signals:JSON.stringify(r)}};document.dispatchEvent(new CustomEvent(J,{detail:t}))}var D={CONNECTING:"connecting",CONNECTED:"connected",DISCONNECTED:"disconnected"},z=0;function Q(r){return async(t,e,n={})=>{if(!!!T.get(t.el))return r(t,e,n);let o=`${++z}`;_.set(o,t.el),setTimeout(()=>_.delete(o),5e3),n.headers={...n.headers,[U]:o},n.retryMaxCount=0;try{return await r(t,e,n)}catch(f){if(f?.message?.startsWith("FetchFailed")){d.info("[Interceptor] Suppressed Datastar FetchFailed error, Retryer will handle reconnection for:",t.el);return}throw f}}}function Z(r){try{let{action:t,actions:e}=r;if(!t||!e)throw new Error("LoadDatastarPlugin requires { action, actions } from Datastar v1.0.0-RC.6. Import them from your Datastar bundle and pass them to LoadDatastarPlugin.");let n=["get","post"];for(let s of n){let o=e[s];if(!o)throw new Error(`[Resilient] Action '${s}' not found in Datastar. Cannot wrap missing action.`);t({name:s,apply:Q(o)}),d.info(`[Resilient] Wrapped Datastar action: ${s}`)}d.info("[Resilient] Successfully loaded Datastar plugin")}catch(t){throw console.error("[Resilient] Failed to load DatastarPlugin:",t),t}}function P({maxInitialAttempts:r=3,initialDelayMs:t=20,maxDelayMs:e=3e4,baseDelayMs:n=1e3,baseMultiplier:s=2}={}){let o=0;return function(f,h,A){return A===-1?(o++,r>0&&o>r?!1:t):Math.min(e,n*Math.pow(s,f))}}var l,w,g,y,S,E,R,C,N,c,G,F,I,K,W,q,x=class{constructor(t,e={}){m(this,c);m(this,l);m(this,w);m(this,g);m(this,y);m(this,S);m(this,E);m(this,R);m(this,C);m(this,N);e=Object.fromEntries(Object.entries(e).filter(([s,o])=>o!=null));let n={debug:!1,backoffCalculator:P(),isFailedRequest:function(s){return s.status>=400},inactivityTimeoutMs:0,enableConnectionEvents:!1,enableDatastarSignals:"",requestInterceptor:null,responseInterceptor:null,dataInterceptor:null};this.element=t,this.options={...n,...e},a(this,l,new b(this.options.debug)),a(this,w,null),a(this,g,0),a(this,y,null),a(this,S,!1),a(this,E,null),a(this,R,null),a(this,C,-1),a(this,N,null),this.init()}init(){T.set(this.element,this),this.notifyRequestStopped(u,!0)}get lastStartTime(){return i(this,w)}get connected(){return i(this,S)}get reconnections(){return i(this,C)}setAbortController(t,e){p(this,c,I).call(this,t),a(this,R,e)}trackSSE(t){p(this,c,I).call(this,t),this.options?.inactivityTimeoutMs>0&&a(this,E,Date.now())}notifyRequestStarted(t){p(this,c,I).call(this,t),a(this,E,Date.now()),a(this,w,Date.now()),p(this,c,q).call(this),i(this,l).info("[Retryer] request started for element:",this.element),p(this,c,G).call(this)}isFailedRequest(t,e){return p(this,c,I).call(this,t),this.options.isFailedRequest(e)}notifyRequestConnected(t){p(this,c,I).call(this,t),a(this,S,!0),a(this,g,0),L(this,C)._++,p(this,c,q).call(this),this.options.enableConnectionEvents&&this.element.dispatchEvent(new Event(Y)),this.options.enableDatastarSignals&&O({[this.options.enableDatastarSignals]:D.CONNECTED}),i(this,l).info("[Retryer] request connected for element:",this.element)}notifyRequestStopped(t,e=!0){p(this,c,I).call(this,t),a(this,R,null),a(this,S,!1),a(this,E,null),p(this,c,F).call(this),this.options.enableConnectionEvents&&this.element.dispatchEvent(new Event(V)),this.options.enableDatastarSignals&&O({[this.options.enableDatastarSignals]:D.DISCONNECTED}),i(this,C)>0&&i(this,l).info("[Retryer] request stopped for element:",this.element),e&&p(this,c,K).call(this)}destroy(){p(this,c,q).call(this),p(this,c,F).call(this),T.delete(this.element),i(this,l).info("[Retryer] Destroyed for element:",this.element)}};l=new WeakMap,w=new WeakMap,g=new WeakMap,y=new WeakMap,S=new WeakMap,E=new WeakMap,R=new WeakMap,C=new WeakMap,N=new WeakMap,c=new WeakSet,G=function(){if(this.options?.inactivityTimeoutMs<=0)return;p(this,c,F).call(this);let t=Math.min(1e3,this.options.inactivityTimeoutMs/2);a(this,N,setInterval(()=>{if(i(this,l).info(`[Retryer] Inactivity monitor check, last SSE at: ${i(this,E)}`),i(this,E)===null)return;let e=Date.now()-i(this,E);if(e>this.options.inactivityTimeoutMs){i(this,l).warn(`[Retryer] Auto-detected inactivity timeout (${this.options.inactivityTimeoutMs}ms), after ${e}ms of no data, aborting connection for element:`,this.element);let n=i(this,R);a(this,R,null),n?.abort("[Retryer] Auto-aborted due to inactivity timeout"),this.notifyRequestStopped(u)}},t)),i(this,l).info(`[Retryer] Started inactivity monitor (checking every ${t}ms) for element:`,this.element)},F=function(){i(this,N)&&(clearInterval(i(this,N)),a(this,N,null),i(this,l).info("[Retryer] Stopped inactivity monitor for element:",this.element))},I=function(t){if(t!==u)throw new Error("[Retryer] Sensitive method called without RETRYER_BYPASS_KEY")},K=function(){if(i(this,y)){i(this,l).info("[Retryer] reconnect already scheduled, skipping for element:",this.element);return}if(!document.body.contains(this.element)){i(this,l).warn("[Retryer] element removed from DOM, not scheduling reconnect");return}L(this,g)._++;let t=this.options.backoffCalculator(i(this,g),i(this,w),i(this,C));if(t===!1){i(this,l).error("[Retryer] retries exhausted, not scheduling reconnect for element:",this.element),this.notifyRequestStopped(u,!1);return}i(this,l).warn(`[Retryer] scheduling reconnect in ${t}ms (retry #${i(this,g)}) for element:`,this.element),a(this,y,setTimeout(()=>{i(this,l).info(`[Retryer] executing scheduled reconnect (retry #${i(this,g)}) for element:`,this.element),a(this,y,null),p(this,c,W).call(this)},t))},W=function(){if(i(this,S)){i(this,l).info("[Retryer] already connected, not firing connect for element:",this.element);return}this.element.dispatchEvent(new Event(k)),this.options.enableDatastarSignals&&O({[this.options.enableDatastarSignals]:D.CONNECTING})},q=function(){i(this,y)&&(clearTimeout(i(this,y)),a(this,y,null))};window.Resilient={Retryer:x,GetRetryer:function(r){return T.get(r)},SimpleBackoffCalculator:P};var v="X-Fetch-Id",d=new b(!1);function tt(r){d.enabled=r}var et=function({url:r,response:t,retryer:e}){return new TransformStream({async transform(n,s){e?.trackSSE(u);try{e?.options.dataInterceptor&&(n=e.options.dataInterceptor({url:r,response:t,chunk:n})??n),s.enqueue(n)}catch(o){d.error("[Interceptor] Error in stream transformer:",o),s.error(o)}}})},B=window.fetch;window.fetch=async function(r,t){let{retryer:e}=rt(r,t);if(!e)return d.info("[Interceptor] No Retryer associated with fetch, calling original fetch."),B(r,t);d.info("[Interceptor] Intercepted fetch with Retryer:",e),e.options.requestInterceptor&&({resource:r,init:t}=e.options.requestInterceptor({resource:r,init:t}));let n=r instanceof Request,s=n?r.url:r,o=new AbortController;t?.signal&&(t.signal.aborted?o.abort(t.signal.reason):t.signal.addEventListener("abort",()=>o.abort(t.signal.reason),{once:!0}));let f={...t,signal:o.signal},h;e.notifyRequestStarted(u),e.setAbortController(u,o);try{if(n?h=await B(r,f):h=await B(s,f),e.isFailedRequest(u,h))throw o.abort("[Interceptor] Fetch aborted by retryer: unexpected response"),d.warn(`[Interceptor] Fetch aborted by retryer: unexpected response for ${s}`,h),new Error("[Interceptor] Fetch aborted by retryer: unexpected response");e.notifyRequestConnected(u)}catch(X){throw e.notifyRequestStopped(u),X}if(d.info(`[Interceptor] fetch response: ${h.status} ${h.statusText} for ${s}`,h),e.options.responseInterceptor&&(h=e.options.responseInterceptor({url:s,response:h})??h),!h.body)return d.info("[Interceptor] response has no body, skipping transformation, for url:",s),h;let A=et({url:s,response:h,retryer:e});return j(h,A)};function rt(r,t){let e=r instanceof Request,n=null,s=null;if(t?.headers&&(n=t.headers instanceof Headers?t.headers.get(v):t.headers?.[v],n&&(s=t.headers)),!n&&e&&(n=r.headers.get(v),n&&(s=null)),!n)return{retryer:null};s&&(s instanceof Headers?s.delete(v):typeof s=="object"&&delete s[v]);let o=_.get(n);if(_.delete(n),!o)return d.error("[Interceptor] No element found for fetchId:",n),{retryer:null};if(!document.contains(o))return d.error("[Interceptor] Element for fetchId is no longer in DOM:",n,o),{retryer:null};let f=T.get(o);return!f||!(f instanceof x)?(d.error("[Interceptor] No Retryer instance found for element:",o),{retryer:null}):{retryer:f}}export{Y as CONNECTED_EVENT,k as CONNECT_EVENT,$ as ContentType,V as DISCONNECTED_EVENT,Z as LoadDatastarPlugin,D as SIGNALS_CONNECTION_STATES,P as SimpleBackoffCalculator,tt as ToggleInterceptorLogging};
