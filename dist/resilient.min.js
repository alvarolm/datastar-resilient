var P=t=>{throw TypeError(t)};var L=(t,e,r)=>e.has(t)||P("Cannot "+r);var s=(t,e,r)=>(L(t,e,"read from private field"),r?r.call(t):e.get(t)),u=(t,e,r)=>e.has(t)?P("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),a=(t,e,r,n)=>(L(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r),p=(t,e,r)=>(L(t,e,"access private method"),r);var A=(t,e,r,n)=>({set _(i){a(t,e,i,r)},get _(){return s(t,e,n)}});var f=Symbol("unsafe"),T=new WeakMap,x=new Map,k="connect",Y="connected",B="disconnected",_=class{constructor(e=!1){this.enabled=e}info(...e){this.enabled&&console.info(...e)}warn(...e){this.enabled&&console.warn(...e)}error(...e){console.error(...e)}},$=class{constructor(e){this.raw=e||"",this._parsed=this._parse()}_parse(){let e=this.raw.split(";").map(i=>i.trim()),r=e[0].toLowerCase(),n={};for(let i=1;i<e.length;i++){let[o,d]=e[i].split("=").map(c=>c.trim());o&&d&&(n[o.toLowerCase()]=d.replace(/^["']|["']$/g,""))}return{mediaType:r,params:n}}get type(){return this._parsed.mediaType.split("/")[0]}get subtype(){return this._parsed.mediaType.split("/")[1]}get params(){return this._parsed.params}get isSSE(){return this._parsed.mediaType==="text/event-stream"}get isJSON(){return this._parsed.mediaType==="application/json"||this._parsed.mediaType.endsWith("+json")}get isHTML(){return this._parsed.mediaType==="text/html"}get isXML(){return this._parsed.mediaType==="application/xml"||this._parsed.mediaType==="text/xml"||this._parsed.mediaType.endsWith("+xml")}get isText(){return this.type==="text"}get isMultipart(){return this.type==="multipart"}get isFormData(){return this._parsed.mediaType==="multipart/form-data"}get isFormURLEncoded(){return this._parsed.mediaType==="application/x-www-form-urlencoded"}get isBinary(){return!this.isText&&!this.isJSON&&!this.isXML&&!this.isHTML}get charset(){return this.params.charset||"utf-8"}is(e){return this._parsed.mediaType===e.toLowerCase()}matches(e){return e instanceof RegExp?e.test(this._parsed.mediaType):new RegExp("^"+e.replace("*",".*")+"$").test(this._parsed.mediaType)}toString(){return this.raw}};function j(t,e){let r=t.body.pipeThrough(e);return new Response(r,{status:t.status,statusText:t.statusText,headers:new Headers(t.headers)})}var J="X-Fetch-Id";function q(t){let e={type:"datastar-patch-signals",argsRaw:{signals:JSON.stringify(t)}};document.dispatchEvent(new CustomEvent("datastar-fetch",{detail:e}))}var D={CONNECTING:"connecting",CONNECTED:"connected",DISCONNECTED:"disconnected"},U=0,z={type:"watcher",name:"element-fetch-mapper",onGlobalInit:t=>{for(let e in t.actions){let r=t.actions[e].fn;t.actions[e].fn=(n,i,o={})=>{if(!!!T.get(n.el))return r(n,i,o);let c=`${++U}`;return x.set(c,n.el),setTimeout(()=>x.delete(c),5e3),o.headers={...o.headers,[J]:c},o.retryMaxCount=0,r(n,i,o).catch(b=>{if(b?.message?.startsWith("FetchFailed")){m.info("[Interceptor] Suppressed Datastar FetchFailed error, Retryer will handle reconnection for:",n.el);return}throw b})}}}};function Q(t){try{t(z)}catch(e){console.error("[Interceptor] Failed to load DatastarPlugin",e)}}function V({maxInitialAttempts:t=3,initialDelayMs:e=20,maxDelayMs:r=3e4,baseDelayMs:n=1e3,baseMultiplier:i=2}={}){let o=0;return function(d,c,b){return b===0?(o++,t>0&&o>t?!1:e):Math.min(r,n*Math.pow(i,d))}}var h,w,g,y,S,E,R,N,I,l,H,F,C,K,W,M,v=class{constructor(e,r={}){u(this,l);u(this,h);u(this,w);u(this,g);u(this,y);u(this,S);u(this,E);u(this,R);u(this,N);u(this,I);r=Object.fromEntries(Object.entries(r).filter(([i,o])=>o!=null));let n={debug:!1,backoffCalculator:V(),isFailedRequest:function(i){return i.status>=400},inactivityTimeoutMs:0,enableConnectionEvents:!1,enableDatastarSignals:"",requestInterceptor:null,responseInterceptor:null,dataInterceptor:null};this.element=e,this.options={...n,...r},a(this,h,new _(this.options.debug)),a(this,w,null),a(this,g,0),a(this,y,null),a(this,S,!1),a(this,E,null),a(this,R,null),a(this,N,-1),a(this,I,null),this.init()}init(){T.set(this.element,this),this.notifyRequestStopped(f,!0)}get lastStartTime(){return s(this,w)}get connected(){return s(this,S)}get reconnections(){return s(this,N)}setAbortController(e,r){p(this,l,C).call(this,e),a(this,R,r)}trackSSE(e){p(this,l,C).call(this,e),this.options?.inactivityTimeoutMs>0&&a(this,E,Date.now())}notifyRequestStarted(e){p(this,l,C).call(this,e),a(this,E,Date.now()),a(this,w,Date.now()),p(this,l,M).call(this),s(this,h).info("[Retryer] request started for element:",this.element),p(this,l,H).call(this)}isFailedRequest(e,r){return p(this,l,C).call(this,e),this.options.isFailedRequest(r)}notifyRequestConnected(e){p(this,l,C).call(this,e),a(this,S,!0),a(this,g,0),A(this,N)._++,p(this,l,M).call(this),this.options.enableConnectionEvents&&this.element.dispatchEvent(new Event(Y)),this.options.enableDatastarSignals&&q({[this.options.enableDatastarSignals]:D.CONNECTED}),s(this,h).info("[Retryer] request connected for element:",this.element)}notifyRequestStopped(e,r=!0){p(this,l,C).call(this,e),a(this,R,null),a(this,S,!1),a(this,E,null),p(this,l,F).call(this),this.options.enableConnectionEvents&&this.element.dispatchEvent(new Event(B)),this.options.enableDatastarSignals&&q({[this.options.enableDatastarSignals]:D.DISCONNECTED}),s(this,N)>0&&s(this,h).info("[Retryer] request stopped for element:",this.element),r&&p(this,l,K).call(this)}destroy(){p(this,l,M).call(this),p(this,l,F).call(this),T.delete(this.element),s(this,h).info("[Retryer] Destroyed for element:",this.element)}};h=new WeakMap,w=new WeakMap,g=new WeakMap,y=new WeakMap,S=new WeakMap,E=new WeakMap,R=new WeakMap,N=new WeakMap,I=new WeakMap,l=new WeakSet,H=function(){if(this.options?.inactivityTimeoutMs<=0)return;p(this,l,F).call(this);let e=Math.min(1e3,this.options.inactivityTimeoutMs/2);a(this,I,setInterval(()=>{if(s(this,h).info(`[Retryer] Inactivity monitor check, last SSE at: ${s(this,E)}`),s(this,E)===null)return;let r=Date.now()-s(this,E);if(r>this.options.inactivityTimeoutMs){s(this,h).warn(`[Retryer] Auto-detected inactivity timeout (${this.options.inactivityTimeoutMs}ms), after ${r}ms of no data, aborting connection for element:`,this.element);let n=s(this,R);a(this,R,null),n?.abort("[Retryer] Auto-aborted due to inactivity timeout"),this.notifyRequestStopped(f)}},e)),s(this,h).info(`[Retryer] Started inactivity monitor (checking every ${e}ms) for element:`,this.element)},F=function(){s(this,I)&&(clearInterval(s(this,I)),a(this,I,null),s(this,h).info("[Retryer] Stopped inactivity monitor for element:",this.element))},C=function(e){if(e!==f)throw new Error("[Retryer] Sensitive method called without RETRYER_BYPASS_KEY")},K=function(){if(s(this,y)){s(this,h).info("[Retryer] reconnect already scheduled, skipping for element:",this.element);return}if(!document.body.contains(this.element)){s(this,h).warn("[Retryer] element removed from DOM, not scheduling reconnect");return}A(this,g)._++;let e=this.options.backoffCalculator(s(this,g),s(this,w),s(this,N));if(e===!1){s(this,h).error("[Retryer] retries exhausted, not scheduling reconnect for element:",this.element),this.notifyRequestStopped(f,!1);return}s(this,h).warn(`[Retryer] scheduling reconnect in ${e}ms (retry #${s(this,g)}) for element:`,this.element),a(this,y,setTimeout(()=>{s(this,h).info(`[Retryer] executing scheduled reconnect (retry #${s(this,g)}) for element:`,this.element),a(this,y,null),p(this,l,W).call(this)},e))},W=function(){if(s(this,S)){s(this,h).info("[Retryer] already connected, not firing connect for element:",this.element);return}this.element.dispatchEvent(new Event(k)),this.options.enableDatastarSignals&&q({[this.options.enableDatastarSignals]:D.CONNECTING})},M=function(){s(this,y)&&(clearTimeout(s(this,y)),a(this,y,null))};window.Resilient={Retryer:v,GetRetryer:function(t){return T.get(t)},SimpleBackoffCalculator:V};var O="X-Fetch-Id",m=new _(!1);function Z(t){m.enabled=t}var ee=function({url:t,response:e,retryer:r}){return new TransformStream({async transform(n,i){r?.trackSSE(f);try{r?.options.dataInterceptor&&(n=r.options.dataInterceptor({url:t,response:e,chunk:n})??n),i.enqueue(n)}catch(o){m.error("[Interceptor] Error in stream transformer:",o),i.error(o)}}})},G=window.fetch;window.fetch=async function(t,e){let{retryer:r}=te(t,e);if(!r)return G(t,e);r.options.requestInterceptor&&({resource:t,init:e}=r.options.requestInterceptor({resource:t,init:e}));let n=t instanceof Request,i=n?t.url:t,o=new AbortController;e?.signal&&(e.signal.aborted?o.abort(e.signal.reason):e.signal.addEventListener("abort",()=>o.abort(e.signal.reason),{once:!0}));let d={...e,signal:o.signal},c;r.notifyRequestStarted(f),r.setAbortController(f,o);try{if(n?c=await G(t,d):c=await G(i,d),r.isFailedRequest(f,c))throw o.abort("[Interceptor] Fetch aborted by retryer: unexpected response"),m.warn(`[Interceptor] Fetch aborted by retryer: unexpected response for ${i}`,c),new Error("[Interceptor] Fetch aborted by retryer: unexpected response");r.notifyRequestConnected(f)}catch(X){throw r.notifyRequestStopped(f),X}if(m.info(`[Interceptor] fetch response: ${c.status} ${c.statusText} for ${i}`,c),r.options.responseInterceptor&&(c=r.options.responseInterceptor({url:i,response:c})??c),!c.body)return m.info("[Interceptor] response has no body, skipping transformation, for url:",i),c;let b=ee({url:i,response:c,retryer:r});return j(c,b)};function te(t,e){let r=t instanceof Request,n=null,i=null;if(e?.headers&&(n=e.headers instanceof Headers?e.headers.get(O):e.headers?.[O],n&&(i=e.headers)),!n&&r&&(n=t.headers.get(O),n&&(i=null)),!n)return{retryer:null};i&&(i instanceof Headers?i.delete(O):typeof i=="object"&&delete i[O]);let o=x.get(n);if(x.delete(n),!o)return m.error("[Interceptor] No element found for fetchId:",n),{retryer:null};if(!document.contains(o))return m.error("[Interceptor] Element for fetchId is no longer in DOM:",n,o),{retryer:null};let d=T.get(o);return!d||!(d instanceof v)?(m.error("[Interceptor] No Retryer instance found for element:",o),{retryer:null}):{retryer:d}}export{Y as CONNECTED_EVENT,k as CONNECT_EVENT,$ as ContentType,B as DISCONNECTED_EVENT,Q as LoadDatastarPlugin,D as SIGNALS_CONNECTION_STATES,V as SimpleBackoffCalculator,Z as ToggleInterceptorLogging};
