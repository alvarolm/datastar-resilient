<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test 2: Random Failures</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div
      class="test-card"
      data-signals='{
             "status": "",
             "count": 0,
             "logs": [],
             "failures": 0
         }'
      data-init="new Resilient.Retryer(el, {
             debug: true,
             enableDatastarSignals: 'status',
             backoffCalculator: Resilient.SimpleBackoffCalculator(
                {maxInitialAttempts: 5, initialDelayMs: 20, maxDelayMs: 500, baseDelayMs:100, baseMultiplier: 2}),
            inactivityTimeoutMs: 1000,
         })"
      data-on:connect="@get('/api/random-failures', {openWhenHidden: true})"
    >
      <a class="endpoint" href="/api/random-failures" target="_blank"
        >/api/random-failures</a
      >
      <h2>Random Failures</h2>
      <p class="description">
        50% chance to fail on connection, disconnects after 4 events. Tests automatic reconnection with
        backoff.
      </p>

      <div
        class="status-bar"
        data-class='{
            "status-unknown": $status === "connecting",
            "status-ok": $status === "connected",
            "status-failed": $status === "disconnected"
        }'
      >
        <div class="indicator"></div>
        <span data-text="$status.toUpperCase()"></span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" data-text="$count"></div>
          <div class="stat-label">Events</div>
        </div>
        <!--
            <div class="stat">
                <div class="stat-value" data-text="$failures"></div>
                <div class="stat-label">Failures</div>
            </div>
            -->
      </div>

      <div class="data-display">
        <pre data-text="$logs.slice(-5).join('\n')"></pre>
      </div>

      <div class="test-status status-unknown">
        <span>Processing</span>
      </div>
    </div>
    <script type="module">
      import { Start, Finish } from "/tests/consoleRecorder.js";

      Start("random_failures_test");

      import { LoadDatastarPlugin } from "/src/index.js";
      import { action, actions } from "https://cdn.jsdelivr.net/gh/starfederation/datastar@v1.0.0-RC.6/bundles/datastar.js";

      LoadDatastarPlugin({ action, actions });

      // make sure:
      // - the retryer instance shows reconnections > 0 after all states are received
      // all this within a reasonable timeout

      const timeoutDuration = 10000; // 10 seconds

      // Set timeout to check if all states were received
      setTimeout(() => {
        const r = Resilient.GetRetryer(document.querySelector(".test-card"));

        if (!r) {
          console.error("Test failed: Could not find Retryer instance");
          Finish({ pass: false });
          return;
        }

        if (r.reconnections === 0) {
          console.error(
            `Test failed: Expected at least 1 reconnection but got ${r.reconnections}`
          );
          Finish({ pass: false });
          return;
        }

        console.log("TEST PASSED");
        Finish({ pass: true });
      }, timeoutDuration);
    </script>
  </body>
</html>
